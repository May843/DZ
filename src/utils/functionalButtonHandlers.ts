// Utilitaires pour rendre tous les boutons fonctionnels avec modales
// 100% AlgÃ©rien - Transformation automatique des Ã©lÃ©ments non fonctionnels

import { createFunctionalHandler } from '@/hooks/useFunctionalModal';

// Mapping des actions vers des sections pour les modales
export const ACTION_TO_SECTION_MAP: Record<string, string> = {
  // Actions de recherche et filtrage
  'handleFilter': 'legal-catalog',
  'handleSort': 'legal-catalog',
  'handleSearch': 'legal-search',
  'handleAdvancedSearch': 'legal-search',
  
  // Actions de procÃ©dures
  'handleDownloadForms': 'procedures-resources',
  'handleConsultGuide': 'procedures-resources',
  'handleBrowseTemplates': 'procedures-catalog',
  
  // Actions OCR
  'handleBatchProcess': 'batch-processing',
  'handleOCRAnalytics': 'ocr-analytics',
  'handleMonitoring': 'ocr-analytics',
  
  // Actions de collaboration
  'handleForum': 'forum',
  'handleCollaborate': 'collaborative-workspace',
  'handleShare': 'shared-resources',
  
  // Actions d'analyse
  'handleCreateDashboard': 'analytics-dashboards',
  'handleAnalyze': 'analysis',
  'handleGenerateReport': 'reports',
  'handleAssistedWriting': 'assisted-writing',
  
  // Actions de configuration
  'handleUserManagement': 'user-management',
  'handleSecurity': 'security',
  'handleAlerts': 'alerts-notifications',
  'handleSettings': 'nomenclature',
  
  // Actions d'actualitÃ©s
  'handleNews': 'news',
  'handleLibrary': 'library',
  'handleDictionary': 'dictionaries',
  'handleDirectory': 'directories'
};

// GÃ©nÃ©rateur de handlers fonctionnels pour les boutons
export const createButtonHandler = (actionName: string, customSection?: string, customTitle?: string) => {
  const section = customSection || ACTION_TO_SECTION_MAP[actionName] || 'dashboard';
  const title = customTitle || `Action: ${actionName}`;
  
  return createFunctionalHandler(section, title);
};

// Transformation automatique des mÃ©thodes console.log en handlers fonctionnels
export const transformConsoleLogsToHandlers = () => {
  // Intercepter les console.log pour les transformer en actions
  const originalConsoleLog = console.log;
  
  console.log = (...args: any[]) => {
    const message = args.join(' ');
    
    // DÃ©tecter les patterns d'actions non fonctionnelles
    const actionPatterns = [
      { pattern: /handleFilter|Filtering|filtrage/i, section: 'legal-catalog', title: 'Filtrage des DonnÃ©es' },
      { pattern: /handleSort|Sorting|tri/i, section: 'legal-catalog', title: 'Tri et Organisation' },
      { pattern: /handleDownload|tÃ©lÃ©charger|download/i, section: 'procedures-resources', title: 'TÃ©lÃ©chargements' },
      { pattern: /handleConsult|consulter|guide/i, section: 'procedures-resources', title: 'Consultation de Guides' },
      { pattern: /handleSearch|recherche|search/i, section: 'legal-search', title: 'Recherche AvancÃ©e' },
      { pattern: /handleAnalyze|analyse|analytics/i, section: 'analytics-dashboards', title: 'Analyses et Rapports' },
      { pattern: /handleCreate|crÃ©er|nouveau/i, section: 'analytics-dashboards', title: 'CrÃ©ation d\'Ã‰lÃ©ments' },
      { pattern: /handleEdit|modifier|edit/i, section: 'user-management', title: 'Modification' },
      { pattern: /handleDelete|supprimer|delete/i, section: 'user-management', title: 'Suppression SÃ©curisÃ©e' },
      { pattern: /handleExport|exporter|export/i, section: 'reports', title: 'Export de DonnÃ©es' },
      { pattern: /handleImport|importer|import/i, section: 'batch-processing', title: 'Import de DonnÃ©es' },
      { pattern: /handleBatch|lot|batch/i, section: 'batch-processing', title: 'Traitement par Lot' },
      { pattern: /handleForum|forum/i, section: 'forum', title: 'Forum Juridique' },
      { pattern: /handleNews|actualitÃ©s|news/i, section: 'news', title: 'ActualitÃ©s Juridiques' },
      { pattern: /handleLibrary|bibliothÃ¨que|library/i, section: 'library', title: 'BibliothÃ¨que' },
      { pattern: /handleUser|utilisateur|user/i, section: 'user-management', title: 'Gestion Utilisateurs' },
      { pattern: /handleAlert|alerte|notification/i, section: 'alerts-notifications', title: 'Alertes et Notifications' },
      { pattern: /handleSecurity|sÃ©curitÃ©|security/i, section: 'security', title: 'SÃ©curitÃ©' },
      { pattern: /handleConfig|configuration|settings/i, section: 'nomenclature', title: 'Configuration' }
    ];
    
    // Chercher un pattern correspondant
    const matchedPattern = actionPatterns.find(({ pattern }) => pattern.test(message));
    
    if (matchedPattern) {
      // Au lieu de logger, dÃ©clencher l'ouverture de la modale
      console.info(`ðŸ‡©ðŸ‡¿ Action transformÃ©e: ${message} -> ${matchedPattern.section}`);
      window.dispatchEvent(new CustomEvent('open-functional-modal', {
        detail: { 
          section: matchedPattern.section, 
          title: matchedPattern.title 
        }
      }));
    } else {
      // Logger normal pour les autres messages
      originalConsoleLog.apply(console, args);
    }
  };
};

// Transformation des handlers de placeholder
export const replacePageholderHandlers = () => {
  // Remplacer les handlers vides par des handlers fonctionnels
  const commonHandlers = [
    'handleFilter',
    'handleSort', 
    'handleSearch',
    'handleDownload',
    'handleConsult',
    'handleAnalyze',
    'handleCreate',
    'handleEdit',
    'handleDelete',
    'handleExport',
    'handleImport',
    'handleShare',
    'handleConfigure'
  ];
  
  commonHandlers.forEach(handlerName => {
    // CrÃ©er un handler global accessible
    (window as any)[handlerName] = createButtonHandler(handlerName);
  });
  
  console.log('ðŸ‡©ðŸ‡¿ Handlers fonctionnels globaux crÃ©Ã©s:', commonHandlers);
};

// Injection de handlers fonctionnels dans les composants
export const injectFunctionalHandlers = (componentName: string) => {
  const handlers: Record<string, any> = {};
  
  // Selon le composant, injecter les handlers appropriÃ©s
  switch (componentName) {
    case 'LegalCatalog':
      handlers.handleFilter = createButtonHandler('handleFilter', 'legal-catalog', 'Filtrage Juridique');
      handlers.handleSort = createButtonHandler('handleSort', 'legal-catalog', 'Tri des Textes');
      handlers.handleSearch = createButtonHandler('handleSearch', 'legal-search', 'Recherche Juridique');
      break;
      
    case 'ProceduresCatalog':
      handlers.handleFilter = createButtonHandler('handleFilter', 'procedures-catalog', 'Filtrage ProcÃ©dures');
      handlers.handleSort = createButtonHandler('handleSort', 'procedures-catalog', 'Tri des ProcÃ©dures');
      handlers.handleDownload = createButtonHandler('handleDownload', 'procedures-resources', 'TÃ©lÃ©chargements');
      break;
      
    case 'OCRBatch':
      handlers.handleBatch = createButtonHandler('handleBatch', 'batch-processing', 'Traitement par Lot');
      handlers.handleMonitor = createButtonHandler('handleMonitor', 'ocr-analytics', 'Surveillance OCR');
      break;
      
    case 'Analytics':
      handlers.handleCreate = createButtonHandler('handleCreate', 'analytics-dashboards', 'CrÃ©er Dashboard');
      handlers.handleAnalyze = createButtonHandler('handleAnalyze', 'analysis', 'Analyses AvancÃ©es');
      handlers.handleReport = createButtonHandler('handleReport', 'reports', 'GÃ©nÃ©ration Rapports');
      break;
      
    default:
      // Handlers gÃ©nÃ©riques
      handlers.handleAction = createButtonHandler('handleAction', 'dashboard', 'Action GÃ©nÃ©rique');
  }
  
  return handlers;
};

// Initialisation automatique au chargement
export const initializeFunctionalHandlers = () => {
  console.log('ðŸ‡©ðŸ‡¿ Initialisation des handlers fonctionnels algÃ©riens...');
  
  // Transformer les console.log
  transformConsoleLogsToHandlers();
  
  // CrÃ©er les handlers globaux
  replacePageholderHandlers();
  
  // Ajouter des listeners pour les boutons sans onClick
  document.addEventListener('click', (event) => {
    const target = event.target as HTMLElement;
    
    // DÃ©tecter les boutons sans handler
    if (target.tagName === 'BUTTON' && !target.onclick && !target.getAttribute('data-functional')) {
      const buttonText = target.textContent?.toLowerCase() || '';
      
      // Patterns pour dÃ©tecter le type d'action
      const buttonPatterns = [
        { pattern: /recherch|search|find/i, section: 'legal-search', title: 'Recherche' },
        { pattern: /filtr|filter/i, section: 'legal-catalog', title: 'Filtrage' },
        { pattern: /tri|sort/i, section: 'legal-catalog', title: 'Tri' },
        { pattern: /tÃ©lÃ©charge|download/i, section: 'procedures-resources', title: 'TÃ©lÃ©chargement' },
        { pattern: /export/i, section: 'reports', title: 'Export' },
        { pattern: /crÃ©er|create|nouveau|new/i, section: 'analytics-dashboards', title: 'CrÃ©ation' },
        { pattern: /modifi|edit|update/i, section: 'user-management', title: 'Modification' },
        { pattern: /supprim|delete|remove/i, section: 'user-management', title: 'Suppression' },
        { pattern: /analys|analytics/i, section: 'analysis', title: 'Analyse' },
        { pattern: /partag|share/i, section: 'shared-resources', title: 'Partage' },
        { pattern: /config|setting|paramÃ¨tr/i, section: 'nomenclature', title: 'Configuration' }
      ];
      
      const matchedPattern = buttonPatterns.find(({ pattern }) => pattern.test(buttonText));
      
      if (matchedPattern) {
        // Marquer le bouton comme traitÃ©
        target.setAttribute('data-functional', 'true');
        
        // Ajouter l'handler
        target.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log(`ðŸ‡©ðŸ‡¿ Bouton automatique cliquÃ©: ${buttonText}`);
          window.dispatchEvent(new CustomEvent('open-functional-modal', {
            detail: { 
              section: matchedPattern.section, 
              title: matchedPattern.title 
            }
          }));
        });
        
        console.log(`ðŸ‡©ðŸ‡¿ Handler automatique ajoutÃ© pour bouton: "${buttonText}" -> ${matchedPattern.section}`);
      }
    }
  });
  
  console.log('âœ… Handlers fonctionnels algÃ©riens initialisÃ©s avec succÃ¨s');
};